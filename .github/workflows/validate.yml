name: Validate SRD Data

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate SRD JSON
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # enable pip cache for faster re-runs

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run validation (file-only)
        id: run_validate
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ingest_srd.py --validate --no-db | tee validation_report.txt
          echo "status=success" >> "$GITHUB_OUTPUT"
      

      - name: Upload validation report
        uses: actions/upload-artifact@v4
        with:
          name: validation_report
          path: validation_report.txt
          if-no-files-found: warn
          retention-days: 7

  summarize:
    name: Summarize Result
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Download validation report
        uses: actions/download-artifact@v4
        with:
          name: validation_report
          path: .

      - name: Write summary
        shell: bash
        run: |
          echo "## SRD Validation — Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if grep -qiE "error|failed" validation_report.txt; then
            echo "❌ **Validation found issues.** See the attached report." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ **Validation passed** — no errors detected." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Show first 50 lines of report</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          head -n 50 validation_report.txt >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"
