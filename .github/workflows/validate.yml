name: Validate SRD Data

on:
  push:
    paths:
      - 'data/srd/**'
      - '.github/workflows/validate.yml'  # keep runs when the workflow itself changes
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate SRD JSON
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"  # enable pip cache for faster re-runs

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run validation (file-only)
        id: run_validate
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ingest_srd.py --validate --no-db 2>&1 | tee validation_report.txt
          echo "status=success" >> "$GITHUB_OUTPUT"

      - name: Write run metadata
        if: always()
        shell: bash
        run: |
          {
            echo "repo=${GITHUB_REPOSITORY}"
            echo "commit_sha=${GITHUB_SHA}"
            echo "ref=${GITHUB_REF}"
            echo "actor=${GITHUB_ACTOR}"
            echo "run_id=${GITHUB_RUN_ID}"
            echo "run_number=${GITHUB_RUN_NUMBER}"
            echo "run_url=${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"
          } > run_meta.txt

      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation_report
          path: |
            validation_report.txt
            run_meta.txt
          if-no-files-found: error
          retention-days: 7

  summarize:
    name: Summarize Result
    if: always()
    runs-on: ubuntu-latest
    needs: [validate]

    steps:
      - name: Download validation report
        if: always()
        uses: actions/download-artifact@v4
        with:
          name: validation_report
          path: .

      - name: Write summary
        if: always()
        shell: bash
        run: |
          echo "## SRD Validation — Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if grep -qiE "error|failed" validation_report.txt; then
            echo "❌ **Validation found issues.** See the artifact \`validation_report\`." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ **Validation passed** — no errors detected." >> "$GITHUB_STEP_SUMMARY"
          fi
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "[Full run logs](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>Show first 50 lines of report</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          head -n 50 validation_report.txt >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

  ingest-db:
    name: Ingest into ephemeral Mongo (CI-only)
    runs-on: ubuntu-latest
    needs: [ validate ]

    services:
      mongo:
        image: mongo:7.0
        # Expose the service to the host runner; hostname 'mongo' won't resolve outside a container job
        ports:
          - 27017:27017

    env:
      # Use localhost since we're not using a containerized job
      MONGODB_URI: mongodb://localhost:27017/dnd_srd_ci

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Wait for Mongo (pymongo ping)
        shell: python
        run: |
          import os, time, sys
          from pymongo import MongoClient
          uri = os.environ["MONGODB_URI"]
          deadline = time.time() + 60
          last = None
          while time.time() < deadline:
            try:
              ok = MongoClient(uri, serverSelectionTimeoutMS=1500).admin.command("ping")["ok"]
              if ok == 1:
                print("MongoDB is ready.")
                break
            except Exception as e:
              last = e
              time.sleep(1)
          else:
            print(f"MongoDB did not become ready: {last}", file=sys.stderr)
            sys.exit(1)

      - name: Ingest with DB writes
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ingest_srd.py --validate --write-db 2>&1 | tee ingest_report.txt

      - name: Run tests (unit/contract)
        shell: bash
        run: |
          set -euo pipefail
          pytest -q

      - name: Upload ingest report
        uses: actions/upload-artifact@v4
        with:
          name: ingest_report
          path: ingest_report.txt
          if-no-files-found: error
          retention-days: 7

      - name: Append run summary
        shell: bash
        run: |
          echo "## DB Ingest — Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          if grep -qiE "error|failed|Traceback" ingest_report.txt; then
            echo "❌ **DB ingest reported issues.** See the \`ingest_report\` artifact." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ **DB ingest completed.** See the \`ingest_report\` artifact for details." >> "$GITHUB_STEP_SUMMARY"
          fi

  atlas-integration:
    name: Atlas integration (secrets-gated)
    runs-on: ubuntu-latest
    needs: [ ingest-db ]

    env:
      ATLAS_MONGODB_URI: ${{ secrets.ATLAS_MONGODB_URI }}

    steps:
      - name: Skip (no Atlas secret)
        if: ${{ env.ATLAS_MONGODB_URI == '' }}
        shell: bash
        run: |
          echo "ATLAS_MONGODB_URI secret not set; skipping Atlas integration job steps." >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        uses: actions/checkout@v5

      - name: Set up Python
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Run Atlas smoke test
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        shell: bash
        run: |
          set -euo pipefail
          pytest -q tests/test_atlas_smoke.py
