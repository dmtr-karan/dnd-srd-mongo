# File: .github/workflows/issues.yml
name: Issues â€” Log & Summarize

on:
  issues:
    types: [opened]
  # Allows manual execution for testing or ad-hoc inspection
  workflow_dispatch:

permissions:
  contents: read
  issues: read

jobs:
  summarize:
    name: Summarize new issue
    runs-on: ubuntu-latest
    steps:
      # Provides repository context for potential future steps
      - name: Checkout
        uses: actions/checkout@v5

      - name: Dump event JSON (for debugging)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const payload = context.payload || {};
            const json = JSON.stringify(payload, null, 2);

            // Write pretty JSON file for inspection
            fs.writeFileSync('event.json', json, 'utf8');

            // Append collapsible block to the run summary
            const summary = [
              '## Raw event payload',
              '',
              '<details><summary>Expand</summary>',
              '',
              '```json',
              json,
              '```',
              '</details>',
              ''
            ].join('\n');

            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, summary, 'utf8');

      - name: Write concise summary
        uses: actions/github-script@v7
        with:
          script: |
            // Support both real issues event and manual dispatch (no issue object)
            const ev = context.payload || {};
            const issue = ev.issue || {};
            const title  = issue.title  ?? "(no title)";
            const number = issue.number ?? "â€”";
            const author = issue.user?.login ?? "unknown";
            const url    = issue.html_url ?? "(no url)";

            const rawLabels = Array.isArray(issue.labels) ? issue.labels : [];
            const labels = rawLabels
              .map(l => (typeof l === 'string' ? l : (l?.name ?? '')))
              .filter(Boolean);

            const body = issue.body ?? "";
            const trimmed = body.length > 400 ? body.slice(0, 400) + "â€¦" : body;

            // Guard against accidental code-fence breakage in summary
            const safeBody = trimmed.replace(/```/g, "``` ");

            const lines = [
              `**Title:** ${title}`,
              `**Number:** #${number}`,
              `**Author:** @${author}`,
              `**Labels:** ${labels.length ? labels.join(", ") : "â€”"}`,
              `**URL:** ${url}`,
              "",
              "#### Body (first 400 chars)",
              "",
              "```text",
              safeBody,
              "```",
            ];

            await core.summary
              .addHeading("ðŸ§¾ Issue summary", 3)
              .addRaw(lines.join("\n"))
              .write();
