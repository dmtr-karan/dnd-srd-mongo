name: CI

on:
  push:
    branches: [ "main" ]
    tags:
      - 'v*'
  pull_request:
    branches: [ "main" ]

jobs:
  unit-contract:
    name: Unit/Contract (ephemeral Mongo)
    runs-on: ubuntu-latest

    services:
      mongo:
        image: mongo:7.0
        ports:
          - 27017:27017

    env:
      MONGODB_URI: mongodb://localhost:27017/dnd_srd_ci

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Wait for Mongo (pymongo ping)
        shell: python
        run: |
          import os, time, sys
          from pymongo import MongoClient
          uri = os.environ["MONGODB_URI"]
          deadline = time.time() + 60
          last = None
          while time.time() < deadline:
            try:
              ok = MongoClient(uri, serverSelectionTimeoutMS=1500).admin.command("ping")["ok"]
              if ok == 1:
                print("MongoDB is ready.")
                break
            except Exception as e:
              last = e
              time.sleep(1)
          else:
            print(f"MongoDB did not become ready: {last}", file=sys.stderr)
            sys.exit(1)

      - name: Ingest with DB writes (pre-test)
        shell: bash
        run: |
          set -euo pipefail
          python scripts/ingest_srd.py --validate --write-db

      - name: Run tests (unit/contract)
        shell: bash
        run: |
          set -euo pipefail
          pytest -q

  atlas-integration:
    name: Atlas integration (secrets-gated)
    runs-on: ubuntu-latest
    needs: [ unit-contract ]

    env:
      ATLAS_MONGODB_URI: ${{ secrets.ATLAS_MONGODB_URI }}

    steps:
      - name: Skip (no Atlas secret)
        if: ${{ env.ATLAS_MONGODB_URI == '' }}
        shell: bash
        run: |
          echo "ATLAS_MONGODB_URI secret not set; skipping Atlas integration job steps." >> "$GITHUB_STEP_SUMMARY"

      - name: Checkout
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        uses: actions/checkout@v5

      - name: Set up Python
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: Run Atlas smoke test
        if: ${{ env.ATLAS_MONGODB_URI != '' }}
        shell: bash
        run: |
          set -euo pipefail
          pytest -q tests/test_atlas_smoke.py
